<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Verification - RijanTudy</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="background-animation"></div>

    <div class="container">
        <div class="form-wrapper">
            <div class="verification-header">
                <i class="fa-solid fa-shield-halved"></i>
                <h1>Security Verification</h1>
                <p>Please answer the following questions to verify your identity</p>
            </div>

            <form id="verification-form" class="verification-form">
                <!-- Question 1 -->
                <div class="question-block">
                    <label>Khadga School Principle sir cast Name?</label>
                    <label class="nepali-label">‡§ñ‡§°‡•ç‡§ó ‡§∏‡•ç‡§ï‡•Ç‡§≤‡§ï‡§æ ‡§™‡•ç‡§∞‡§ø‡§®‡•ç‡§∏‡§ø‡§™‡§≤ ‡§∏‡§∞‡§ï‡•ã ‡§ú‡§æ‡§§‡§ï‡•ã ‡§®‡§æ‡§Æ?</label>
                    <input type="text" id="principal-name" class="form-input" placeholder="Enter name" required>
                </div>

                <!-- Question 2 -->
                <div class="question-block">
                    <label>Computer class after which time started?</label>
                    <label class="nepali-label">‡§ï‡§Æ‡•ç‡§™‡•ç‡§Ø‡•Å‡§ü‡§∞ ‡§ï‡•ç‡§≤‡§æ‡§∏ ‡§ï‡•Å‡§® ‡§∏‡§Æ‡§Ø ‡§™‡§õ‡§ø ‡§∏‡•Å‡§∞‡•Å ‡§π‡•Å‡§®‡•ç‡§õ?</label>
                    <input type="time" id="class-time" class="form-input" value="09:30" required>
                </div>

                <!-- Question 3 (Facebook ID - shown conditionally) -->
                <div class="question-block" id="facebook-section" style="display:none;">
                    <label>Facebook ID <span class="required">*</span></label>
                    <input type="text" id="facebook-id" class="form-input"
                        placeholder="Your Facebook profile URL or username">
                    <p class="verification-note">
                        <i class="fa-solid fa-info-circle"></i>
                        If facebook id verify take some hours
                    </p>
                </div>

                <button type="submit" class="primary-btn">
                    <i class="fa-solid fa-check-circle"></i> Submit Verification
                </button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD8eu916dt7z5lKH95XqNKeyinpdZ77M1I",
            authDomain: "rijantube-13baf.firebaseapp.com",
            databaseURL: "https://rijantube-13baf-default-rtdb.firebaseio.com",
            projectId: "rijantube-13baf",
            storageBucket: "rijantube-13baf.firebasestorage.app",
            messagingSenderId: "268588154453",
            appId: "1:268588154453:web:ce0aa25f0dd2e6a23e8f28"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        const form = document.getElementById('verification-form');
        const principalInput = document.getElementById('principal-name');
        const classTimeInput = document.getElementById('class-time');
        const facebookSection = document.getElementById('facebook-section');
        const facebookInput = document.getElementById('facebook-id');

        // Check if user already verified
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "index.html";
                return;
            }

            // Check verification status
            const userRef = ref(db, 'users/' + user.uid);
            const snapshot = await get(userRef);

            if (snapshot.exists()) {
                const userData = snapshot.val();
                if (userData.verificationStatus === 'approved') {
                    window.location.href = "home.html";
                    return;
                }
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const user = auth.currentUser;
            if (!user) return;

            const principalName = principalInput.value.trim();
            const classTime = classTimeInput.value;
            const facebookId = facebookInput.value.trim();

            // Check answers
            const isPrincipalCorrect = principalName.toLowerCase() === 'ojha';
            const isTimeCorrect = classTime === '09:30';

            let verificationStatus = 'approved';
            let requiresFacebook = false;

            if (!isPrincipalCorrect || !isTimeCorrect) {
                // Wrong answers - require Facebook ID
                if (!facebookId && facebookSection.style.display === 'none') {
                    facebookSection.style.display = 'block';
                    facebookInput.required = true;
                    alert('Please provide your Facebook ID for manual verification');
                    return;
                }

                if (!facebookId) {
                    alert('Facebook ID is required for verification');
                    return;
                }

                verificationStatus = 'pending';
                requiresFacebook = true;
            }

            // Save to Firebase
            const verificationData = {
                verificationStatus: verificationStatus,
                verificationAnswers: {
                    principalName: principalName,
                    classTime: classTime,
                    facebookId: facebookId || ''
                },
                verificationTimestamp: Date.now(),
                userName: user.displayName || 'Anonymous',
                userEmail: user.email,
                userPhoto: user.photoURL || ''
            };

            const userRef = ref(db, 'users/' + user.uid);
            await set(userRef, verificationData);

            if (verificationStatus === 'approved') {
                alert('‚úÖ Verification successful! Welcome to RijanTudy.');
                window.location.href = "home.html";
            } else {
                alert('üìã Your verification is pending admin approval. You will be notified once reviewed.');
                window.location.href = "home.html";
            }
        });
    </script>
</body>

</html>